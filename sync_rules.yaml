# PowerSync Sync Rules
# This file defines which data is synced to which users
#
# NOTE: Server-Only Columns
# ─────────────────────────────────────────────────────────────────────────────
# The following columns exist in the PostgreSQL database but are intentionally
# NOT synced to clients:
#
#   - server_created_at: When the server first received and stored the record
#   - server_updated_at: When the server last processed an update to the record
#
# These server timestamps are used for audit trails, sync debugging, and analytics.
# They are separate from client timestamps (created_at, updated_at) which represent
# when the user performed the action on their device (which may be hours/days before
# sync if the user was offline).
#
# See DatabaseDesignGuidelines.md section 8 for more details.
# ─────────────────────────────────────────────────────────────────────────────

bucket_definitions:
  # Global data accessible to all authenticated users
  global:
    data:
      - SELECT code as id, code FROM currencies
      - |
        SELECT
          id,
          base_currency,
          quote_currency,
          rate,
          rate_date
        FROM exchange_rates

  # User-specific data
  user_data:
    parameters: SELECT request.user_id() as user_id
    data:
      # User preferences
      - |
        SELECT
          user_id as id,
          user_id,
          default_currency,
          first_weekday,
          locale,
          created_at,
          updated_at
        FROM user_preferences
        WHERE user_id = bucket.user_id

      # User's categories
      - |
        SELECT
          id,
          user_id,
          type,
          parent_id,
          name,
          description,
          icon,
          sort_order,
          is_archived,
          archived_at,
          created_at,
          updated_at
        FROM categories
        WHERE user_id = bucket.user_id

      # User's budgets
      - |
        SELECT
          id,
          user_id,
          category_id,
          amount,
          currency_id,
          period,
          budget_year,
          budget_month,
          created_at,
          updated_at
        FROM budgets
        WHERE user_id = bucket.user_id

      # User's accounts
      - |
        SELECT
          id,
          user_id,
          type,
          name,
          description,
          currency_id,
          balance,
          savings_target_amount,
          savings_target_date,
          debt_initial_amount,
          debt_due_date,
          is_archived,
          archived_at,
          created_at,
          updated_at
        FROM accounts
        WHERE user_id = bucket.user_id

      # User's events (cross-category spending tracking)
      - |
        SELECT
          id,
          user_id,
          name,
          description,
          start_date,
          end_date,
          is_archived,
          archived_at,
          created_at,
          updated_at
        FROM events
        WHERE user_id = bucket.user_id

      # User's transactions
      - |
        SELECT
          id,
          user_id,
          type,
          account_id,
          counter_account_id,
          category_id,
          event_id,
          amount,
          currency_id,
          tx_date,
          notes,
          created_at,
          updated_at
        FROM transactions
        WHERE user_id = bucket.user_id

      # User's attachments
      - |
        SELECT
          id,
          user_id,
          type,
          status,
          bucket_path,
          mime,
          file_name,
          file_size,
          duration,
          uploaded_at,
          created_at,
          updated_at
        FROM attachments
        WHERE user_id = bucket.user_id

      # Transaction attachments
      - |
        SELECT
          id,
          user_id,
          transaction_id,
          attachment_id,
          created_at,
          updated_at
        FROM transaction_attachments
        WHERE user_id = bucket.user_id

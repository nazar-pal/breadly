# PowerSync Sync Rules
# This file defines which data is synced to which users
# ---------------------------------------------------------------------------------
# Conventions used below:
# 1) Date/timestamp columns â†’ `CAST(unixepoch(col) * 1000 AS integer)`
#    PowerSync helper returns seconds; multiplying by 1000 converts to milliseconds,
#    and casting to integer ensures 64-bit integer ms for `{ mode: 'timestamp_ms' }` columns.
# 2) Monetary columns are stored as bigint (smallest currency unit) - no conversion needed.
# Keep comments minimal; adjust only when new date or numeric fields are added.
# ---------------------------------------------------------------------------------

bucket_definitions:
  # Global data accessible to all authenticated users
  global:
    data:
      - SELECT code as id, code FROM currencies
      - |
        SELECT
          id,
          base_currency,
          quote_currency,
          rate,
          rate_date
        FROM exchange_rates

  # User-specific data
  user_data:
    parameters: SELECT request.user_id() as user_id
    data:
      # User preferences
      - |
        SELECT
          user_id as id,
          user_id,
          default_currency,
          first_weekday,
          locale,
          CAST(unixepoch(created_at) * 1000 AS integer) AS created_at,
          CAST(unixepoch(updated_at) * 1000 AS integer) AS updated_at
        FROM user_preferences
        WHERE user_id = bucket.user_id

      # User's categories (convert created_at and archived_at)
      - |
        SELECT
          id,
          user_id,
          type,
          parent_id,
          name,
          description,
          icon,
          sort_order,
          is_archived,
          CAST(unixepoch(archived_at) * 1000 AS integer) AS archived_at,
          CAST(unixepoch(created_at) * 1000 AS integer) AS created_at,
          CAST(unixepoch(updated_at) * 1000 AS integer) AS updated_at
        FROM categories
        WHERE user_id = bucket.user_id

      # User's budgets (one row per period - simple and explicit)
      - |
        SELECT
          id,
          user_id,
          category_id,
          amount,
          currency_id,
          period,
          budget_year,
          budget_month,
          CAST(unixepoch(created_at) * 1000 AS integer) AS created_at,
          CAST(unixepoch(updated_at) * 1000 AS integer) AS updated_at
        FROM budgets
        WHERE user_id = bucket.user_id

      # User's accounts (leave date-only fields as DATE -> TEXT)
      - |
        SELECT
          id,
          user_id,
          type,
          name,
          description,
          currency_id,
          balance,
          savings_target_amount,
          savings_target_date,
          debt_initial_amount,
          debt_due_date,
          is_archived,
          CAST(unixepoch(archived_at) * 1000 AS integer) AS archived_at,
          CAST(unixepoch(created_at) * 1000 AS integer) AS created_at,
          CAST(unixepoch(updated_at) * 1000 AS integer) AS updated_at
        FROM accounts
        WHERE user_id = bucket.user_id

      # User's events (cross-category spending tracking)
      - |
        SELECT
          id,
          user_id,
          name,
          description,
          start_date,
          end_date,
          is_archived,
          CAST(unixepoch(archived_at) * 1000 AS integer) AS archived_at,
          CAST(unixepoch(created_at) * 1000 AS integer) AS created_at,
          CAST(unixepoch(updated_at) * 1000 AS integer) AS updated_at
        FROM events
        WHERE user_id = bucket.user_id

      # User's transactions (leave tx_date as DATE -> TEXT)
      - |
        SELECT
          id,
          user_id,
          type,
          account_id,
          counter_account_id,
          category_id,
          event_id,
          amount,
          currency_id,
          tx_date,
          notes,
          CAST(unixepoch(created_at) * 1000 AS integer) AS created_at,
          CAST(unixepoch(updated_at) * 1000 AS integer) AS updated_at
        FROM transactions
        WHERE user_id = bucket.user_id

      # User's attachments (convert timestamps)
      - |
        SELECT
          id,
          user_id,
          type,
          status,
          bucket_path,
          mime,
          file_name,
          CAST(file_size AS integer) AS file_size,
          duration,
          CAST(unixepoch(uploaded_at) * 1000 AS integer) AS uploaded_at,
          CAST(unixepoch(created_at) * 1000 AS integer) AS created_at,
          CAST(unixepoch(updated_at) * 1000 AS integer) AS updated_at
        FROM attachments
        WHERE user_id = bucket.user_id

      # Transaction attachments (convert created_at)
      - |
        SELECT
          id,
          user_id,
          transaction_id,
          attachment_id,
          CAST(unixepoch(created_at) * 1000 AS integer) AS created_at,
          CAST(unixepoch(updated_at) * 1000 AS integer) AS updated_at
        FROM transaction_attachments
        WHERE user_id = bucket.user_id
